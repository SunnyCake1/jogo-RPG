<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Procedural: A Saga Infinita</title>
    <style>
        /* --- ESTILO VISUAL "DARK FANTASY" --- */
        :root { --bg: #050505; --panel: #111; --border: #333; --accent: #ffcc00; --danger: #ff4444; --text: #e0e0e0; }
        
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; }
        
        /* MENU DE CRIA√á√ÉO */
        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99; display: flex; flex-direction: column; align-items: center; justify-content: center; background-image: url('https://image.pollinations.ai/prompt/dark%20fantasy%20rpg%20castle?width=1080&height=720&nologo=true'); background-size: cover; }
        .menu-box { background: rgba(0,0,0,0.9); padding: 40px; border: 1px solid var(--accent); border-radius: 8px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .input-group { margin: 15px 0; text-align: left; }
        .input-group label { display: block; color: var(--accent); margin-bottom: 5px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
        .input-group input, .input-group select { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        .start-btn { background: var(--accent); color: #000; border: none; padding: 15px; width: 100%; font-weight: bold; font-size: 1.1em; cursor: pointer; text-transform: uppercase; margin-top: 20px; transition: 0.3s; }
        .start-btn:hover { background: #ffaa00; transform: scale(1.02); }

        /* JOGO PRINCIPAL */
        #game-container { display: flex; width: 100%; height: 100%; opacity: 0; pointer-events: none; transition: opacity 1s; }
        #main-stage { flex: 3; padding: 30px; display: flex; flex-direction: column; position: relative; overflow-y: auto; }
        #sidebar { flex: 1; min-width: 250px; background: var(--panel); border-left: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }

        /* CENA E IMAGEM */
        #scene-image { width: 100%; height: 350px; object-fit: cover; border-radius: 8px; border: 1px solid #444; margin-bottom: 20px; background: #222; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: opacity 0.3s; }
        
        /* COMBATE UI */
        #combat-panel { display: none; background: #2a0a0a; border: 1px solid var(--danger); padding: 15px; border-radius: 8px; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 5px #500; } 50% { box-shadow: 0 0 15px #800; } 100% { box-shadow: 0 0 5px #500; } }
        .hp-bar-bg { background: #400; height: 12px; width: 100%; border-radius: 6px; margin-top: 5px; overflow: hidden; }
        .hp-bar-fill { background: #f00; height: 100%; width: 100%; transition: width 0.3s; }

        /* BOT√ïES DE A√á√ÉO */
        .action-btn { background: #1e1e1e; color: #ccc; border: 1px solid #333; padding: 18px; margin: 8px 0; width: 100%; cursor: pointer; border-radius: 5px; text-align: left; font-size: 16px; transition: 0.2s; position: relative; }
        .action-btn:hover:not(:disabled) { background: #2a2a2a; border-color: var(--accent); color: white; padding-left: 25px; }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .combat-btn { border-color: var(--danger); }
        .combat-btn:hover { background: #300; border-color: #f00; }

        /* INVENT√ÅRIO E STATS */
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 4px; font-size: 0.9em; }
        .stat-val { color: var(--accent); font-weight: bold; }
        .item-row { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.85em; border: 1px solid #333; }
        .small-btn { background: #333; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em; }
        .small-btn:hover { background: var(--accent); color: black; }
        .use-btn { background: #2a9d8f; } .use-btn:hover { background: #20c997; }

        #game-log { margin-top: auto; height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.8em; color: #888; border-top: 1px solid #333; padding-top: 10px; }
        .log-msg { margin-bottom: 4px; }
        .log-new { color: #fff; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <div class="menu-box">
            <h1 style="color:white; margin-top:0;">RPG PROCEDURAL</h1>
            <p id="loading-status" style="color: var(--accent);">Conectando ao Banco de Dados...</p>
            
            <div id="form-creation" style="display: none;">
                <div class="input-group">
                    <label>Nome do Her√≥i</label>
                    <input type="text" id="hero-name" placeholder="Ex: Arthur">
                </div>
                <div class="input-group">
                    <label>Linhagem (Ra√ßa)</label>
                    <select id="hero-race"></select>
                </div>
                <div class="input-group">
                    <label>Classe</label>
                    <select id="hero-class">
                        <option value="guerreiro">Guerreiro (+Vida, +Ataque)</option>
                        <option value="mago">Mago (+Mana)</option>
                        <option value="ladino">Ladino (+Sorte, +Cr√≠tico)</option>
                    </select>
                </div>
                <button class="start-btn" onclick="Game.start()">Iniciar Jornada</button>
            </div>
        </div>
    </div>

    <div id="game-container">
        <div id="main-stage">
            <img id="scene-image" src="" alt="Cena">
            
            <div id="combat-panel">
                <h3 style="margin:0; color:var(--danger)">‚öîÔ∏è COMBATE!</h3>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <span id="enemy-name" style="font-weight:bold; color:white">Inimigo</span>
                    <span id="enemy-hp-text" style="color:var(--danger)">HP: 100%</span>
                </div>
                <div class="hp-bar-bg"><div id="enemy-hp-bar" class="hp-bar-fill"></div></div>
            </div>

            <div id="narrative-text" style="font-size: 1.1em; line-height: 1.6; color: #ccc; margin-bottom: 20px;"></div>
            <div id="choices-area"></div>
        </div>

        <div id="sidebar">
            <h3 id="ui-name" style="color: white; border-bottom: 2px solid var(--accent); padding-bottom: 5px;">Her√≥i</h3>
            
            <div class="stat-row"><span>‚ù§Ô∏è Vida</span> <span class="stat-val"><span id="ui-hp"></span>/<span id="ui-maxhp"></span></span></div>
            <div class="stat-row"><span>‚ú® Mana</span> <span class="stat-val" id="ui-mana"></span></div>
            <div class="stat-row"><span>‚öîÔ∏è Ataque</span> <span class="stat-val" id="ui-atk"></span></div>
            <div class="stat-row"><span>üõ°Ô∏è Defesa</span> <span class="stat-val" id="ui-def">0</span></div>
            <div class="stat-row"><span>üß¨ Ra√ßa</span> <span class="stat-val" id="ui-race"></span></div>
            
            <div style="margin-top: 15px; font-weight:bold; color:white; border-bottom:1px solid #333">Equipamento</div>
            <div id="ui-equip" style="color:#888; font-size:0.9em; margin: 5px 0 15px 0;">M√£o: (Nada)</div>

            <div style="font-weight:bold; color:white; border-bottom:1px solid #333">Mochila</div>
            <div id="inventory-list" style="margin-top: 5px;"></div>

            <div id="game-log"></div>
        </div>
    </div>

<script>
/**
 * --- CONFIGURA√á√ÉO DO SISTEMA ---
 * Links diretos para suas abas publicadas como CSV.
 */
const DATA_LINKS = {
    VILOES: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=0&single=true&output=csv",
    RACAS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=1264466421&single=true&output=csv",
    ITENS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=111995480&single=true&output=csv",
    DROPS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=1548671969&single=true&output=csv",
    EVENTOS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=468277323&single=true&output=csv"
};

// --- ESTADO GLOBAL ---
const DB = {}; // Banco de dados carregado
const Player = {
    name: "Viajante",
    stats: { hp: 100, maxHp: 100, mana: 50, atk: 5, def: 0 },
    race: null,
    villain: null,
    inventory: [],
    equipment: { hand: null },
    flags: {} // Mem√≥ria do mundo
};
const Combat = { active: false, enemy: null };

/**
 * --- ENGINE (MOTOR DO JOGO) ---
 */
const Game = {
    // Passo 1: Carregar Dados
    init: async () => {
        try {
            const fetchSheet = async (url) => {
                const res = await fetch(url);
                const text = await res.text();
                return Game.parseCSV(text);
            };

            const promises = Object.keys(DATA_LINKS).map(key => fetchSheet(DATA_LINKS[key]).then(data => DB[key] = data));
            await Promise.all(promises);

            Game.setupMenu();
        } catch (e) {
            document.getElementById('loading-status').innerText = "Erro ao carregar CSVs. Verifique a internet.";
            console.error(e);
        }
    },

    // Parser de CSV robusto
    parseCSV: (text) => {
        const lines = text.split("\n").filter(l => l.trim() !== "");
        const headers = lines[0].split(",").map(h => h.trim());
        return lines.slice(1).map(line => {
            const values = line.split(",");
            return headers.reduce((obj, header, i) => {
                obj[header] = values[i] ? values[i].trim() : "";
                return obj;
            }, {});
        });
    },

    // Passo 2: Configurar Menu
    setupMenu: () => {
        document.getElementById('loading-status').style.display = 'none';
        document.getElementById('form-creation').style.display = 'block';
        
        const raceSelect = document.getElementById('hero-race');
        DB.RACAS.forEach((r, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = r.Nome;
            raceSelect.appendChild(opt);
        });
    },

    // Passo 3: Iniciar Jogo
    start: () => {
        // Coleta dados
        Player.name = document.getElementById('hero-name').value || "Viajante";
        Player.race = DB.RACAS[document.getElementById('hero-race').value];
        const pClass = document.getElementById('hero-class').value;

        // Balanceamento de Classe
        if (pClass === 'guerreiro') { Player.stats.maxHp = 120; Player.stats.atk = 8; }
        if (pClass === 'mago') { Player.stats.mana = 100; Player.stats.atk = 3; }
        if (pClass === 'ladino') { Player.stats.atk = 6; Player.stats.def = 2; }
        
        Player.stats.hp = Player.stats.maxHp;
        
        // Sorteia Vil√£o
        Player.villain = DB.VILOES[Math.floor(Math.random() * DB.VILOES.length)];

        // Transi√ß√£o de Tela
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-container').style.opacity = '1';
        document.getElementById('game-container').style.pointerEvents = 'all';

        UI.update();
        UI.log(`Bem-vindo, ${Player.name}! A saga come√ßa.`);
        Game.nextScene("Voc√™ acorda em um mundo desconhecido...");
    },

    // Passo 4: Loop de Cenas (Procedural)
    nextScene: (extraText = "") => {
        if (Combat.active) return;

        // Seleciona Evento (Evitando repeti√ß√µes via Flags)
        let event;
        let tries = 0;
        do {
            event = DB.EVENTOS[Math.floor(Math.random() * DB.EVENTOS.length)];
            tries++;
        } while (Player.flags[event.ID] && tries < 20);

        // Gera Imagem IA
        const keyword = event.Keyword_Imagem || "fantasy landscape";
        const imgUrl = `https://image.pollinations.ai/prompt/cinematic dark fantasy art of ${keyword}?width=700&height=400&nologo=true&seed=${Math.random()}`;
        document.getElementById('scene-image').src = imgUrl;

        // Processa Texto
        const minionName = Player.villain ? (Player.villain.Estilo_Capanga || "Inimigo") : "Inimigo";
        const narrative = event.Texto_Base.replace("[Capanga]", minionName);
        
        const textArea = document.getElementById('narrative-text');
        textArea.innerHTML = (extraText ? `<span style="color:var(--accent)">${extraText}</span><br><br>` : "") + narrative;

        // Renderiza Bot√µes
        const choicesArea = document.getElementById('choices-area');
        choicesArea.innerHTML = "";

        ["Opcao1", "Opcao2", "Opcao3"].forEach(optKey => {
            if (event[optKey]) {
                const btn = document.createElement("button");
                btn.className = "action-btn";
                
                // Custo de Mana
                const cost = parseInt(event.Custo_Mana) || 0;
                btn.innerText = event[optKey] + (cost > 0 ? ` (‚ú® -${cost} Mana)` : "");
                
                // Bloqueio se sem Mana
                if (cost > 0 && Player.stats.mana < cost) {
                    btn.disabled = true;
                }

                btn.onclick = () => Game.processChoice(event[optKey], event);
                choicesArea.appendChild(btn);
            }
        });
    },

    // Processador de Escolhas
    processChoice: (text, event) => {
        // Custo
        const cost = parseInt(event.Custo_Mana) || 0;
        Player.stats.mana -= cost;

        // Mem√≥ria
        if (event.ID) Player.flags[event.ID] = true;

        // Verifica Combate
        if (text.includes("Atacar") || text.includes("Lutar") || text.includes("Combater")) {
            const enemyName = Player.villain ? Player.villain.Estilo_Capanga : "Monstro";
            CombatSystem.start(enemyName);
            return;
        }

        // Verifica Loot (Chance 40%)
        if (Math.random() > 0.6) Inventory.generateLoot();

        UI.update();
        Game.nextScene(`Voc√™ decidiu: ${text}`);
    }
};

/**
 * --- SISTEMA DE COMBATE ---
 */
const CombatSystem = {
    start: (enemyName) => {
        Combat.active = true;
        // Status do Inimigo (Base + Aleat√≥rio)
        Combat.enemy = { 
            name: enemyName, 
            hp: 40, maxHp: 40, 
            atk: 5 
        };

        // UI de Combate
        document.getElementById('combat-panel').style.display = 'block';
        document.getElementById('enemy-name').innerText = enemyName;
        
        // Imagem do Inimigo
        const imgUrl = `https://image.pollinations.ai/prompt/scary ${enemyName} monster rpg art?width=700&height=400&nologo=true&seed=${Math.random()}`;
        document.getElementById('scene-image').src = imgUrl;
        
        document.getElementById('narrative-text').innerText = `Um ${enemyName} hostil bloqueia seu caminho!`;
        CombatSystem.renderButtons();
        CombatSystem.updateBars();
    },

    renderButtons: () => {
        const area = document.getElementById('choices-area');
        area.innerHTML = "";

        const atkBtn = document.createElement("button");
        atkBtn.className = "action-btn combat-btn";
        atkBtn.innerText = "‚öîÔ∏è Atacar com Arma";
        atkBtn.onclick = () => CombatSystem.turn('attack');
        area.appendChild(atkBtn);

        const fleeBtn = document.createElement("button");
        fleeBtn.className = "action-btn";
        fleeBtn.innerText = "üèÉ Tentar Fugir";
        fleeBtn.onclick = () => CombatSystem.turn('flee');
        area.appendChild(fleeBtn);
    },

    turn: (action) => {
        let msg = "";

        // 1. Turno Jogador
        if (action === 'attack') {
            const weaponDmg = Player.equipment.hand ? parseInt(Player.equipment.hand.Dano || 0) : 0;
            const dmg = Player.stats.atk + weaponDmg + Math.floor(Math.random() * 3);
            Combat.enemy.hp -= dmg;
            msg += `Voc√™ causou <b>${dmg}</b> de dano! `;
            UI.log(`Ataque: ${dmg} dmg`);
        } else if (action === 'flee') {
            if (Math.random() > 0.5) {
                CombatSystem.end(false);
                Game.nextScene("Voc√™ escapou por pouco!");
                return;
            } else {
                msg += "Falha na fuga! ";
            }
        }

        // 2. Checa Vit√≥ria
        if (Combat.enemy.hp <= 0) {
            CombatSystem.end(true);
            return;
        }

        // 3. Turno Inimigo
        const enemyDmg = Math.max(0, (Combat.enemy.atk + Math.floor(Math.random() * 2)) - Player.stats.def);
        Player.stats.hp -= enemyDmg;
        msg += `<br>O inimigo revidou com <b>${enemyDmg}</b> de dano.`;
        UI.log(`Recebeu: ${enemyDmg} dmg`);

        // 4. Checa Derrota
        if (Player.stats.hp <= 0) {
            alert("GAME OVER! Seu her√≥i caiu.");
            location.reload();
        }

        document.getElementById('narrative-text').innerHTML = msg;
        CombatSystem.updateBars();
        UI.update();
    },

    updateBars: () => {
        const pct = Math.max(0, (Combat.enemy.hp / Combat.enemy.maxHp) * 100);
        document.getElementById('enemy-hp-bar').style.width = `${pct}%`;
        document.getElementById('enemy-hp-text').innerText = `HP: ${Math.floor(pct)}%`;
    },

    end: (victory) => {
        Combat.active = false;
        document.getElementById('combat-panel').style.display = 'none';
        if (victory) {
            UI.log("Inimigo derrotado!");
            Inventory.generateLoot();
            Game.nextScene("Vit√≥ria! O inimigo caiu aos seus p√©s.");
        }
    }
};

/**
 * --- INVENT√ÅRIO ---
 */
const Inventory = {
    generateLoot: () => {
        const item = DB.ITENS[Math.floor(Math.random() * DB.ITENS.length)];
        if (item) {
            Player.inventory.push(item);
            UI.log(`Loot: ${item.Nome}`);
            alert(`Voc√™ encontrou: ${item.Nome}`);
            UI.update();
        }
    },

    equip: (index) => {
        const item = Player.inventory[index];
        // Desequipa atual
        if (Player.equipment.hand) Player.inventory.push(Player.equipment.hand);
        // Equipa novo
        Player.equipment.hand = item;
        Player.inventory.splice(index, 1);
        UI.log(`Equipou: ${item.Nome}`);
        UI.update();
    },

    use: (index) => {
        const item = Player.inventory[index];
        if (item.Nome.includes("Vida")) {
            Player.stats.hp = Math.min(Player.stats.hp + 25, Player.stats.maxHp);
            UI.log("Usou Po√ß√£o de Vida");
        } else if (item.Nome.includes("Mana")) {
            Player.stats.mana += 25;
            UI.log("Usou Po√ß√£o de Mana");
        }
        Player.inventory.splice(index, 1);
        UI.update();
    }
};

/**
 * --- UI & UTILIT√ÅRIOS ---
 */
const UI = {
    update: () => {
        // Stats
        document.getElementById('ui-name').innerText = Player.name;
        document.getElementById('ui-hp').innerText = Player.stats.hp;
        document.getElementById('ui-maxhp').innerText = Player.stats.maxHp;
        document.getElementById('ui-mana').innerText = Player.stats.mana;
        document.getElementById('ui-def').innerText = Player.stats.def;
        document.getElementById('ui-race').innerText = Player.race ? Player.race.Nome : "-";

        // Ataque Total
        const wpnDmg = Player.equipment.hand ? parseInt(Player.equipment.hand.Dano || 0) : 0;
        document.getElementById('ui-atk').innerText = `${Player.stats.atk + wpnDmg} (${Player.stats.atk}+${wpnDmg})`;

        // Equipamento
        document.getElementById('ui-equip').innerText = Player.equipment.hand 
            ? `‚öîÔ∏è ${Player.equipment.hand.Nome} (+${wpnDmg} Atk)` 
            : "M√£o: (Vazio)";

        // Invent√°rio
        const list = document.getElementById('inventory-list');
        list.innerHTML = "";
        if (Player.inventory.length === 0) list.innerHTML = "<div style='color:#666; font-size:0.8em'>Vazio</div>";

        Player.inventory.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = "item-row";
            div.innerHTML = `<span>${item.Nome}</span>`;

            if (item.Tipo === "Arma") {
                const btn = document.createElement('button');
                btn.className = "small-btn";
                btn.innerText = "Equipar";
                btn.onclick = () => Inventory.equip(i);
                div.appendChild(btn);
            } else if (item.Tipo === "Pocao" || item.Tipo === "Consumivel") {
                const btn = document.createElement('button');
                btn.className = "small-btn use-btn";
                btn.innerText = "Usar";
                btn.onclick = () => Inventory.use(i);
                div.appendChild(btn);
            }
            list.appendChild(div);
        });
    },

    log: (msg) => {
        const logEl = document.getElementById('game-log');
        const line = document.createElement('div');
        line.className = "log-msg log-new";
        line.innerText = `> ${msg}`;
        logEl.prepend(line);
    }
};

// Inicializa
Game.init();

</script>
</body>
</html>
