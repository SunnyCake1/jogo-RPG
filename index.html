<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>RPG Procedural - Mundo Vivo</title>
    <style>
        body { background: #121212; color: #eee; font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; height: 100vh; }
        #game { flex: 3; padding: 40px; display: flex; flex-direction: column; }
        #sidebar { flex: 1; background: #1a1a1a; padding: 20px; border-left: 2px solid #333; overflow-y: auto; }
        .btn { background: #333; color: #ffcc00; border: 1px solid #555; padding: 15px; margin: 10px 0; cursor: pointer; border-radius: 5px; text-align: left; font-size: 16px; transition: 0.2s; width: 100%; }
        .btn:hover:not(:disabled) { background: #444; border-color: #ffcc00; transform: translateX(5px); }
        .btn:disabled { color: #666; cursor: not-allowed; border-color: #333; opacity: 0.6; }
        .log-entry { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #333; color: #aaa; font-size: 0.9em; }
        .destaque { color: #fff; font-weight: bold; }
        #combat-screen { display: none; background: #2a0a0a; padding: 20px; border-radius: 10px; border: 1px solid #ff4444; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="game">
    <h2 id="titulo-cena" style="color: #ffcc00;">Carregando...</h2>
    
    <div id="combat-screen">
        <h3 style="color: #ff4444; margin-top: 0;">‚öîÔ∏è EM COMBATE!</h3>
        <p>Inimigo: <span id="enemy-name" class="destaque">Monstro</span> | HP: <span id="enemy-hp">??</span></p>
        <div id="combat-log" style="font-style: italic; color: #ccc; margin-bottom: 10px;"></div>
    </div>

    <div id="texto-narrativo" style="font-size: 1.2em; line-height: 1.6; margin-bottom: 20px; min-height: 80px;"></div>
    <div id="opcoes-area" style="display: flex; flex-direction: column;"></div>
</div>

<div id="sidebar">
    <h3>Status do Her√≥i</h3>
    <p>‚ù§Ô∏è Vida: <span id="hp" class="stat-val">-</span> / <span id="max-hp">100</span></p>
    <p>‚ú® Mana: <span id="mana" class="stat-val">-</span></p>
    <p>‚öîÔ∏è Ataque: <span id="atk" class="stat-val">10</span></p>
    <p>üë§ Ra√ßa: <span id="raca" class="stat-val">-</span></p>
    <p>üë∫ Vil√£o: <span id="vilao" class="stat-val">-</span></p>
    <hr>
    <h3>üéí Invent√°rio</h3>
    <ul id="inventario-lista" style="padding-left: 20px;"></ul>
    <hr>
    <h3>üìú Hist√≥rico</h3>
    <div id="game-log" style="height: 150px; overflow-y: auto;"></div>
</div>

<script>
// --- CONFIGURA√á√ÉO ---
const LINKS_SISTEMA = {
    VILOES: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=0&single=true&output=csv",
    RACAS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=1264466421&single=true&output=csv",
    ITENS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=111995480&single=true&output=csv",
    DROPS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=1548671969&single=true&output=csv",
    EVENTOS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=468277323&single=true&output=csv"
};

let DB = {};
// Adicionamos 'flags' para a mem√≥ria do mundo e 'combat' para estado de luta
let player = { hp: 100, maxHp: 100, mana: 50, atk: 5, raca: "", vilao: "", inv: [], flags: {} };
let combatState = { active: false, enemy: null };

// --- ENGINE ---

function parseCSV(text) {
    const lines = text.split("\n");
    const headers = lines[0].split(",");
    return lines.slice(1).map(line => {
        const values = line.split(",");
        return headers.reduce((obj, header, i) => {
            obj[header.trim()] = values[i] ? values[i].trim() : "";
            return obj;
        }, {});
    });
}

async function carregarDados() {
    try {
        const responses = await Promise.all(Object.values(LINKS_SISTEMA).map(url => fetch(url).then(r => r.text())));
        const keys = Object.keys(LINKS_SISTEMA);
        keys.forEach((key, i) => { DB[key] = parseCSV(responses[i]); });
        iniciarAventura();
    } catch (err) {
        document.getElementById('titulo-cena').innerText = "Erro de Conex√£o";
    }
}

function log(msg) {
    const logDiv = document.getElementById('game-log');
    const entry = document.createElement('div');
    entry.className = "log-entry";
    entry.innerText = `> ${msg}`;
    logDiv.prepend(entry);
}

function iniciarAventura() {
    player.vilao = DB.VILOES[Math.floor(Math.random() * DB.VILOES.length)];
    player.raca = DB.RACAS[Math.floor(Math.random() * DB.RACAS.length)];
    
    // Aplica b√¥nus de ra√ßa inicial (L√≥gica simples)
    if(player.raca.Nome === "An√£o") player.maxHp += 20;
    if(player.raca.Nome === "Elfo") player.mana += 20;
    player.hp = player.maxHp;

    atualizarUI();
    proximaCena("Sua jornada come√ßa...");
}

function atualizarUI() {
    document.getElementById('hp').innerText = player.hp;
    document.getElementById('max-hp').innerText = player.maxHp;
    document.getElementById('mana').innerText = player.mana;
    document.getElementById('atk').innerText = player.atk; // Mostra ataque base
    document.getElementById('raca').innerText = player.raca.Nome || "Viajante";
    document.getElementById('vilao').innerText = player.vilao.Nome || "Desconhecido";
    
    const lista = document.getElementById('inventario-lista');
    lista.innerHTML = player.inv.length ? "" : "<li>(Vazio)</li>";
    player.inv.forEach(item => {
        let li = document.createElement('li');
        li.innerText = `üì¶ ${item.Nome}`; // Exibe nome do item
        lista.appendChild(li);
    });

    // Se HP chegar a 0
    if (player.hp <= 0) {
        alert("GAME OVER! A escurid√£o te consumiu.");
        location.reload(); // Reinicia o jogo
    }
}

function processarEscolha(textoOpcao, evento) {
    // 1. Custo de Mana
    let custoMana = parseInt(evento.Custo_Mana) || 0;
    if (player.mana < custoMana) {
        alert("Mana insuficiente!");
        return;
    }
    player.mana -= custoMana;

    // 2. Mem√≥ria (Flag) - Se o evento tiver ID, salvamos que ele j√° ocorreu
    if(evento.ID) player.flags[evento.ID] = true;

    // 3. Combate ou Loot?
    // Se o texto da op√ß√£o for "Atacar", iniciamos combate (L√≥gica simples para teste)
    if (textoOpcao.includes("Atacar") || textoOpcao.includes("Lutar")) {
        iniciarCombate(player.vilao.Estilo_Capanga); // Usa o capanga do vil√£o atual
        return; // Sai da fun√ß√£o normal e entra no modo combate
    }

    // 4. Loot Padr√£o
    if (Math.random() > 0.6) ganharLoot();

    log(`Voc√™ escolheu: ${textoOpcao}`);
    atualizarUI();
    proximaCena(`A√ß√£o realizada: ${textoOpcao}`);
}

function iniciarCombate(nomeInimigo) {
    combatState.active = true;
    combatState.enemy = { nome: nomeInimigo, hp: 30, atk: 4 }; // Valores base para teste
    
    document.getElementById('combat-screen').style.display = 'block';
    document.getElementById('enemy-name').innerText = nomeInimigo;
    document.getElementById('enemy-hp').innerText = combatState.enemy.hp;
    document.getElementById('combat-log').innerText = "Um inimigo hostil apareceu!";
    
    // Muda a interface para bot√µes de combate
    gerarBotoesCombate();
}

function turnoCombate(acao) {
    let logMsg = "";
    
    // Turno do Jogador
    if (acao === 'ataque') {
        let dano = player.atk + Math.floor(Math.random() * 3); // Dano vari√°vel
        combatState.enemy.hp -= dano;
        logMsg = `Voc√™ causou ${dano} de dano!`;
    }

    // Verifica Vit√≥ria
    if (combatState.enemy.hp <= 0) {
        combatState.active = false;
        document.getElementById('combat-screen').style.display = 'none';
        ganharLoot(); // Recompensa
        log("Vit√≥ria! Inimigo derrotado.");
        proximaCena("O inimigo caiu diante de voc√™.");
        return;
    }

    // Turno do Inimigo
    let danoInimigo = combatState.enemy.atk;
    player.hp -= danoInimigo;
    logMsg += ` O inimigo revidou com ${danoInimigo} de dano!`;

    // Atualiza Tela de Combate
    document.getElementById('enemy-hp').innerText = combatState.enemy.hp;
    document.getElementById('combat-log').innerText = logMsg;
    atualizarUI();
}

function gerarBotoesCombate() {
    const area = document.getElementById('opcoes-area');
    area.innerHTML = "";

    const btnAtk = document.createElement("button");
    btnAtk.className = "btn";
    btnAtk.innerText = "‚öîÔ∏è Atacar com Arma";
    btnAtk.onclick = () => turnoCombate('ataque');
    area.appendChild(btnAtk);

    const btnFugir = document.createElement("button");
    btnFugir.className = "btn";
    btnFugir.innerText = "üèÉ Tentar Fugir";
    btnFugir.onclick = () => {
        if(Math.random() > 0.5) {
            combatState.active = false;
            document.getElementById('combat-screen').style.display = 'none';
            proximaCena("Voc√™ escapou por pouco!");
        } else {
            document.getElementById('combat-log').innerText = "Fuga falhou! Inimigo atacou.";
            turnoCombate('nada'); // Passa turno e apanha
        }
    };
    area.appendChild(btnFugir);
}

function ganharLoot() {
    const itemSorteado = DB.ITENS[Math.floor(Math.random() * DB.ITENS.length)];
    if (itemSorteado) {
        player.inv.push(itemSorteado);
        // Se for arma, aumenta ataque (L√≥gica simples)
        if(itemSorteado.Tipo === "Arma") player.atk += parseInt(itemSorteado.Dano || 2);
        log(`Item obtido: ${itemSorteado.Nome}`);
        alert(`Voc√™ encontrou: ${itemSorteado.Nome}!`);
    }
}

function proximaCena(textoExtra = "") {
    let evento;
    let tentativas = 0;
    
    // L√≥gica de Mem√≥ria: Tenta achar um evento que n√£o aconteceu ainda
    do {
        evento = DB.EVENTOS[Math.floor(Math.random() * DB.EVENTOS.length)];
        tentativas++;
    } while (player.flags[evento.ID] && tentativas < 10); // Evita loop infinito se tudo j√° aconteceu

    const capanga = player.vilao.Estilo_Capanga || "Inimigo";
    let narrativa = evento.Texto_Base.replace("[Capanga]", capanga);
    
    document.getElementById('titulo-cena').innerText = "O que voc√™ faz?";
    document.getElementById('texto-narrativo').innerText = (textoExtra ? textoExtra + "\n\n" : "") + narrativa;

    const area = document.getElementById('opcoes-area');
    area.innerHTML = "";

    ["Opcao1", "Opcao2", "Opcao3"].forEach(opt => {
        if(evento[opt]) {
            const btn = document.createElement("button");
            btn.className = "btn";
            let custo = parseInt(evento.Custo_Mana) || 0;
            btn.innerText = evento[opt] + (custo > 0 ? ` (üíß -${custo})` : "");
            
            // L√≥gica para desabilitar se n√£o tiver mana
            if (custo > 0 && player.mana < custo) {
                btn.disabled = true;
                btn.innerText += " [Mana Insuficiente]";
            }

            btn.onclick = () => processarEscolha(evento[opt], evento);
            area.appendChild(btn);
        }
    });
}

carregarDados();
</script>
</body>
</html>
