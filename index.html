<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>RPG Procedural: Sistema Real</title>
    <style>
        :root { --bg: #050505; --panel: #111; --border: #333; --accent: #ffcc00; --text: #e0e0e0; --danger: #ff4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; }
        
        /* LAYOUT GERAL */
        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .menu-box { background: rgba(20,20,20,0.95); padding: 40px; border: 1px solid var(--accent); border-radius: 8px; width: 90%; max-width: 400px; text-align: center; }
        
        #game-container { display: flex; width: 100%; height: 100%; opacity: 0; pointer-events: none; transition: opacity 1s; }
        #main-stage { flex: 3; padding: 30px; display: flex; flex-direction: column; position: relative; overflow-y: auto; }
        #sidebar { flex: 1; min-width: 280px; background: var(--panel); border-left: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }

        /* ELEMENTOS VISUAIS */
        #scene-image { width: 100%; height: 350px; object-fit: cover; border-radius: 8px; border: 1px solid #444; margin-bottom: 20px; background: #222; }
        
        .action-btn { background: #1e1e1e; color: #ccc; border: 1px solid #333; padding: 15px; margin: 8px 0; width: 100%; cursor: pointer; border-radius: 5px; text-align: left; font-size: 16px; transition: 0.2s; }
        .action-btn:hover:not(:disabled) { background: #333; border-color: var(--accent); color: white; padding-left: 20px; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: #500; color: #700; }

        /* COMBATE */
        #combat-panel { display: none; background: #2a0a0a; border: 1px solid var(--danger); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .hp-bar-bg { background: #400; height: 15px; width: 100%; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .hp-bar-fill { background: #f00; height: 100%; width: 100%; transition: width 0.3s; }

        /* TABELAS DE DADOS */
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 5px 0; }
        .item-row { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 8px; margin-bottom: 5px; border: 1px solid #333; font-size: 0.9em; }
        
        .small-btn { background: #333; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 0.8em; }
        .equip-btn:hover { background: var(--accent); color: black; }
        .use-btn { background: #2a9d8f; }
        
        #debug-log { font-size: 0.7em; color: #555; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <div class="menu-box">
            <h1 style="color:var(--accent); margin:0;">RPG DATA-DRIVEN</h1>
            <p style="color:#888; font-size:0.9em;">Carregando sua Planilha Google...</p>
            <div id="loading-status" style="color: white; font-weight: bold; margin: 10px 0;">Conectando...</div>
            
            <div id="form-creation" style="display: none;">
                <input type="text" id="hero-name" placeholder="Nome do Her√≥i" style="width:90%; padding:10px; margin:10px 0;">
                <select id="hero-race" style="width:95%; padding:10px; margin:10px 0;"></select>
                <button onclick="Game.start()" style="background:var(--accent); border:none; padding:15px 30px; font-weight:bold; cursor:pointer; width:100%;">JOGAR</button>
            </div>
            <div id="debug-log"></div>
        </div>
    </div>

    <div id="game-container">
        <div id="main-stage">
            <img id="scene-image" src="" alt="Cena">
            
            <div id="combat-panel">
                <h3 style="margin:0; color:var(--danger)">‚öîÔ∏è COMBATE ATIVO</h3>
                <div style="display:flex; justify-content:space-between;">
                    <span id="enemy-name" style="font-weight:bold">Inimigo</span>
                    <span id="enemy-hp-text">HP: 100%</span>
                </div>
                <div class="hp-bar-bg"><div id="enemy-hp-bar" class="hp-bar-fill"></div></div>
            </div>

            <div id="narrative-text" style="font-size: 1.2em; line-height: 1.6; color: #ccc; margin-bottom: 20px;"></div>
            <div id="choices-area"></div>
        </div>

        <div id="sidebar">
            <h3 style="border-bottom: 1px solid var(--accent); color:white;">FICHA</h3>
            <div class="stat-row"><span>Nome</span> <span id="ui-name" style="color:var(--accent)">-</span></div>
            <div class="stat-row"><span>Ra√ßa</span> <span id="ui-race">-</span></div>
            <div class="stat-row"><span>‚ù§Ô∏è Vida</span> <span id="ui-hp">-</span></div>
            <div class="stat-row"><span>‚ú® Mana</span> <span id="ui-mana">-</span></div>
            <div class="stat-row"><span>‚öîÔ∏è Ataque</span> <span id="ui-atk">-</span></div>
            
            <h4 style="margin-top:20px; color:white;">EQUIPAMENTO</h4>
            <div id="ui-equip-hand" style="color:#888; font-size:0.9em">M√£o: Vazio</div>

            <h4 style="margin-top:20px; color:white;">MOCHILA</h4>
            <div id="inventory-list"></div>

            <div id="game-log" style="margin-top:auto; height:150px; overflow-y:auto; border-top:1px solid #333; font-size:0.8em; color:#777; padding-top:10px;"></div>
        </div>
    </div>

<script>
// --- SEUS LINKS (N√£o altere a menos que mude a planilha) ---
const SHEET_LINKS = {
    VILOES: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=0&single=true&output=csv",
    RACAS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=1264466421&single=true&output=csv",
    ITENS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=111995480&single=true&output=csv",
    DROPS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=1548671969&single=true&output=csv",
    EVENTOS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=468277323&single=true&output=csv"
};

// --- ESTADO DO JOGO ---
const DB = {}; 
const Player = { 
    name: "", stats: { hp: 100, maxHp: 100, mana: 50, atk: 5 }, 
    race: {}, villain: {}, inventory: [], equip: { hand: null }, flags: {} 
};
const Combat = { active: false, enemy: {} };

// --- 1. CARREGADOR DE DADOS INTELIGENTE ---
const Loader = {
    init: async () => {
        try {
            const promises = Object.keys(SHEET_LINKS).map(key => 
                fetch(SHEET_LINKS[key])
                .then(res => res.text())
                .then(txt => DB[key] = Loader.parseCSV(txt))
            );
            await Promise.all(promises);
            
            // Log para conferir se carregou
            document.getElementById('debug-log').innerText = 
                `Carregado: ${DB.VILOES.length} Vil√µes, ${DB.ITENS.length} Itens, ${DB.EVENTOS.length} Eventos.`;
            
            Loader.setupMenu();
        } catch (e) {
            document.getElementById('loading-status').innerText = "ERRO NA LEITURA DA PLANILHA";
            console.error(e);
        }
    },

    // Normalizador: Transforma "Nome" e "nome" na mesma chave para evitar erros
    parseCSV: (text) => {
        const lines = text.split("\n").filter(l => l.trim() !== "");
        const headers = lines[0].split(",").map(h => h.trim().toLowerCase()); // Cabe√ßalhos em min√∫sculo
        
        return lines.slice(1).map(line => {
            // Lida com v√≠rgulas dentro de aspas (caso o texto tenha v√≠rgula)
            const values = [];
            let inQuote = false;
            let val = "";
            for (let char of line) {
                if (char === '"') { inQuote = !inQuote; }
                else if (char === ',' && !inQuote) { values.push(val.trim()); val = ""; }
                else { val += char; }
            }
            values.push(val.trim());

            return headers.reduce((obj, header, i) => {
                obj[header] = values[i] || "";
                return obj;
            }, {});
        });
    },

    setupMenu: () => {
        document.getElementById('loading-status').style.display = 'none';
        document.getElementById('form-creation').style.display = 'block';
        const sel = document.getElementById('hero-race');
        DB.RACAS.forEach((r, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = r.nome; // L√™ a coluna 'nome' da planilha
            sel.appendChild(opt);
        });
    }
};

// --- 2. SISTEMA CENTRAL ---
const Game = {
    start: () => {
        Player.name = document.getElementById('hero-name').value || "Viajante";
        const raceIdx = document.getElementById('hero-race').value;
        Player.race = DB.RACAS[raceIdx];
        
        // Aplica B√¥nus da Ra√ßa (Lendo as colunas da planilha)
        Player.stats.maxHp += parseInt(Player.race.bonus_vida || 0);
        Player.stats.hp = Player.stats.maxHp;
        Player.stats.mana += parseInt(Player.race.bonus_mana || 0);
        Player.stats.atk += parseInt(Player.race.bonus_ataque || 0);

        // Sorteia Vil√£o da Planilha
        Player.villain = DB.VILOES[Math.floor(Math.random() * DB.VILOES.length)];

        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-container').style.opacity = '1';
        document.getElementById('game-container').style.pointerEvents = 'all';

        UI.update();
        UI.log(`Iniciado: ${Player.name} (${Player.race.nome}) vs ${Player.villain.nome}`);
        Game.nextScene("A aventura come√ßa...");
    },

    nextScene: (extraText = "") => {
        if (Combat.active) return;

        // Seleciona Evento (Evitando flags)
        let ev;
        let tries = 0;
        do {
            ev = DB.EVENTOS[Math.floor(Math.random() * DB.EVENTOS.length)];
            tries++;
        } while (Player.flags[ev.id] && tries < 15);

        // Imagem IA baseada na Keyword da Planilha
        const keyword = ev.keyword_imagem || "fantasy landscape";
        document.getElementById('scene-image').src = `https://image.pollinations.ai/prompt/dark fantasy ${keyword}?width=700&height=350&nologo=true&seed=${Math.random()}`;

        // Texto Procedural (Substitui [Capanga])
        const minion = Player.villain.estilo_capanga || "Inimigo";
        const txt = ev.texto_base.replace("[Capanga]", minion);
        
        document.getElementById('narrative-text').innerHTML = (extraText ? `<b style='color:#ffcc00'>${extraText}</b><br><br>` : "") + txt;

        // Op√ß√µes
        const area = document.getElementById('choices-area');
        area.innerHTML = "";
        
        ['opcao1', 'opcao2', 'opcao3'].forEach(optKey => {
            if (ev[optKey]) {
                const btn = document.createElement("button");
                btn.className = "action-btn";
                
                // Custo (lendo coluna custo_mana)
                const cost = parseInt(ev.custo_mana || 0);
                const reqVal = parseInt(ev.requisito_valor || 0);
                const reqType = ev.requisito_tipo || "";

                let label = ev[optKey];
                if (cost > 0) label += ` (‚ú® -${cost})`;

                // Valida√ß√£o de Requisito da Planilha
                if (cost > Player.stats.mana) {
                    btn.disabled = true;
                    label += " [Sem Mana]";
                }
                
                // Exemplo: Requisito de Vida
                if (reqType.toLowerCase() === 'vida' && Player.stats.hp < reqVal) {
                    btn.disabled = true;
                    label += " [Muito Ferido]";
                }

                btn.innerText = label;
                btn.onclick = () => Game.resolveChoice(ev[optKey], ev);
                area.appendChild(btn);
            }
        });
    },

    resolveChoice: (choiceText, ev) => {
        // Deduz Custo
        Player.stats.mana -= parseInt(ev.custo_mana || 0);
        
        // Salva Mem√≥ria
        if (ev.id) Player.flags[ev.id] = true;

        // Verifica Gatilho de Combate (palavra chave no texto da op√ß√£o)
        if (choiceText.toLowerCase().includes("atacar") || choiceText.toLowerCase().includes("lutar")) {
            CombatSystem.start();
            return;
        }

        // Tenta Loot (Usando a Tabela_Drop real)
        if (Math.random() * 100 < 40) { // 40% de chance de achar algo
            LootSystem.roll();
        }

        UI.update();
        Game.nextScene(`Voc√™ escolheu: ${choiceText}`);
    }
};

// --- 3. SISTEMA DE COMBATE REAL ---
const CombatSystem = {
    start: () => {
        Combat.active = true;
        // Pega stats do Vil√£o na planilha ou usa padr√£o
        const hpBase = parseInt(Player.villain.vida || 50);
        const atkBase = parseInt(Player.villain.ataque || 5);
        
        Combat.enemy = { 
            name: Player.villain.estilo_capanga || "Monstro",
            hp: hpBase, 
            maxHp: hpBase,
            atk: atkBase
        };

        document.getElementById('combat-panel').style.display = 'block';
        document.getElementById('enemy-name').innerText = Combat.enemy.name;
        document.getElementById('narrative-text').innerText = `Um ${Combat.enemy.name} ataca!`;
        
        // Imagem do Inimigo
        document.getElementById('scene-image').src = `https://image.pollinations.ai/prompt/scary ${Combat.enemy.name} monster?width=700&height=350&nologo=true`;

        CombatSystem.renderUI();
    },

    renderUI: () => {
        // Atualiza Barra
        const pct = (Combat.enemy.hp / Combat.enemy.maxHp) * 100;
        document.getElementById('enemy-hp-bar').style.width = `${pct}%`;
        document.getElementById('enemy-hp-text').innerText = `${Math.floor(Combat.enemy.hp)}/${Combat.enemy.maxHp}`;

        // Bot√µes de Combate
        const area = document.getElementById('choices-area');
        area.innerHTML = "";
        
        const btnAtk = document.createElement("button");
        btnAtk.className = "action-btn";
        btnAtk.style.borderColor = "#ff4444";
        btnAtk.innerText = "‚öîÔ∏è Atacar com Arma";
        btnAtk.onclick = () => CombatSystem.turn('atk');
        area.appendChild(btnAtk);

        const btnFlee = document.createElement("button");
        btnFlee.className = "action-btn";
        btnFlee.innerText = "üèÉ Fugir";
        btnFlee.onclick = () => CombatSystem.turn('flee');
        area.appendChild(btnFlee);
    },

    turn: (act) => {
        let msg = "";
        
        // Turno Player
        if (act === 'atk') {
            const wpnDmg = Player.equip.hand ? parseInt(Player.equip.hand.dano || 0) : 0;
            const dmg = Player.stats.atk + wpnDmg + Math.floor(Math.random()*3);
            Combat.enemy.hp -= dmg;
            msg += `Voc√™ causou ${dmg} de dano! `;
            UI.log(`Ataque: ${dmg} dmg`);
        } else if (act === 'flee') {
            if (Math.random() > 0.5) {
                Combat.active = false;
                document.getElementById('combat-panel').style.display = 'none';
                Game.nextScene("Voc√™ fugiu com sucesso!");
                return;
            }
            msg += "Falha ao fugir! ";
        }

        // Verifica Vit√≥ria
        if (Combat.enemy.hp <= 0) {
            Combat.active = false;
            document.getElementById('combat-panel').style.display = 'none';
            LootSystem.roll(); // Recompensa
            Game.nextScene("Vit√≥ria! O inimigo foi derrotado.");
            return;
        }

        // Turno Inimigo
        const enemyDmg = Combat.enemy.atk + Math.floor(Math.random()*2);
        Player.stats.hp -= enemyDmg;
        msg += `Inimigo causou ${enemyDmg} de dano.`;
        UI.log(`Recebeu ${enemyDmg} dmg`);

        if (Player.stats.hp <= 0) {
            alert("GAME OVER");
            location.reload();
        }

        document.getElementById('narrative-text').innerText = msg;
        CombatSystem.renderUI();
        UI.update();
    }
};

// --- 4. SISTEMA DE LOOT (DROP) CORRIGIDO ---
const LootSystem = {
    roll: () => {
        // 1. Rola D100
        const d100 = Math.floor(Math.random() * 100) + 1;
        
        // 2. Busca na Tabela_Drop
        // Filtra linhas onde o d100 est√° dentro da 'faixa_sorte' (ex: "1-70")
        const dropRow = DB.DROPS.find(row => {
            const parts = row.faixa_sorte.split('-'); // Separa "1" e "70"
            const min = parseInt(parts[0]);
            const max = parseInt(parts[1]);
            return d100 >= min && d100 <= max;
        });

        if (dropRow) {
            // 3. Pega o ID_Item e busca na aba ITENS
            const item = DB.ITENS.find(i => i.id_item === dropRow.id_item);
            if (item) {
                Player.inventory.push(item);
                UI.log(`Loot: ${item.nome}`);
                alert(`Voc√™ encontrou: ${item.nome}!`);
                UI.update();
            }
        }
    }
};

// --- 5. INVENT√ÅRIO & UI ---
const Inventory = {
    equip: (index) => {
        const item = Player.inventory[index];
        if (Player.equip.hand) Player.inventory.push(Player.equip.hand);
        Player.equip.hand = item;
        Player.inventory.splice(index, 1);
        UI.log(`Equipou ${item.nome}`);
        UI.update();
    },
    use: (index) => {
        const item = Player.inventory[index];
        if (item.nome.toLowerCase().includes('vida')) Player.stats.hp += 20;
        if (item.nome.toLowerCase().includes('mana')) Player.stats.mana += 20;
        Player.inventory.splice(index, 1);
        UI.update();
    }
};

const UI = {
    update: () => {
        document.getElementById('ui-name').innerText = Player.name;
        document.getElementById('ui-race').innerText = Player.race.nome || "-";
        document.getElementById('ui-hp').innerText = `${Player.stats.hp}/${Player.stats.maxHp}`;
        document.getElementById('ui-mana').innerText = Player.stats.mana;
        
        const wpnDmg = Player.equip.hand ? parseInt(Player.equip.hand.dano || 0) : 0;
        document.getElementById('ui-atk').innerText = `${Player.stats.atk + wpnDmg} (${Player.stats.atk}+${wpnDmg})`;
        
        document.getElementById('ui-equip-hand').innerText = Player.equip.hand ? `‚öîÔ∏è ${Player.equip.hand.nome}` : "Vazio";

        const list = document.getElementById('inventory-list');
        list.innerHTML = "";
        Player.inventory.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = "item-row";
            div.innerHTML = `<span>${item.nome}</span>`;
            
            const btn = document.createElement('button');
            btn.className = "small-btn";
            
            if (item.tipo.toLowerCase() === 'arma') {
                btn.innerText = "Equipar";
                btn.onclick = () => Inventory.equip(i);
            } else {
                btn.innerText = "Usar";
                btn.className += " use-btn";
                btn.onclick = () => Inventory.use(i);
            }
            div.appendChild(btn);
            list.appendChild(div);
        });
    },
    log: (msg) => {
        const d = document.getElementById('game-log');
        d.innerHTML = `> ${msg}<br>` + d.innerHTML;
    }
};

Loader.init();
</script>
</body>
</html>
