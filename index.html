<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>RPG Procedural - Edi√ß√£o Definitiva</title>
    <style>
        body { background: #050505; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; height: 100vh; overflow: hidden; }
        
        /* MENU INICIAL */
        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; background-image: url('https://image.pollinations.ai/prompt/fantasy%20rpg%20map?width=1080&height=720&nologo=true'); background-size: cover; }
        .menu-box { background: rgba(0,0,0,0.9); padding: 40px; border: 1px solid #ffcc00; border-radius: 10px; width: 400px; text-align: center; box-shadow: 0 0 50px rgba(255, 204, 0, 0.2); backdrop-filter: blur(5px); }
        .input-group { margin: 15px 0; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: #ffcc00; font-size: 0.9em; }
        .input-group select, .input-group input { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }
        .start-btn { background: linear-gradient(45deg, #ffcc00, #ffaa00); color: #000; font-weight: bold; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 1.2em; width: 100%; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .start-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px #ffcc00; }

        /* JOGO PRINCIPAL */
        #game-container { display: flex; width: 100%; height: 100%; opacity: 0; pointer-events: none; transition: 1s; }
        #game { flex: 3; padding: 30px; display: flex; flex-direction: column; position: relative; }
        #sidebar { flex: 1; background: #111; padding: 20px; border-left: 1px solid #333; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* IMAGEM E UI */
        #scene-image { width: 100%; height: 300px; object-fit: cover; border-radius: 8px; border: 1px solid #444; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); background: #222; transition: opacity 0.5s; }
        
        .btn { background: #222; color: #ccc; border: 1px solid #444; padding: 18px; margin: 8px 0; cursor: pointer; border-radius: 5px; text-align: left; font-size: 16px; transition: 0.2s; position: relative; overflow: hidden; }
        .btn:hover:not(:disabled) { background: #333; border-color: #ffcc00; color: #fff; padding-left: 25px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* COMBATE UI */
        #combat-ui { display: none; background: #2a0a0a; padding: 15px; border: 1px solid #ff4444; border-radius: 8px; margin-bottom: 20px; animation: pulseRed 2s infinite; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 5px #500; } 50% { box-shadow: 0 0 20px #500; } 100% { box-shadow: 0 0 5px #500; } }
        .combat-stat { font-size: 1.2em; font-weight: bold; color: #ff5555; }

        /* INVENT√ÅRIO */
        .item-row { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #333; font-size: 0.9em; }
        .equip-btn { background: #333; color: #fff; border: none; padding: 4px 8px; cursor: pointer; font-size: 0.8em; border-radius: 3px; }
        .equip-btn:hover { background: #ffcc00; color: #000; }

        /* STATS */
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .stat-val { color: #ffcc00; font-weight: bold; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <div class="menu-box">
            <h1 style="color: #fff; margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 2px;">RPG PROCEDURAL</h1>
            <div id="loading-msg" style="color: #ffcc00; font-size: 0.9em;">Baixando dados do servidor...</div>
            
            <div id="character-creation" style="display: none;">
                <div class="input-group">
                    <label>Nome do Her√≥i</label>
                    <input type="text" id="input-nome" placeholder="Digite seu nome...">
                </div>
                <div class="input-group">
                    <label>Linhagem (Ra√ßa)</label>
                    <select id="select-raca"></select>
                </div>
                <div class="input-group">
                    <label>Classe</label>
                    <select id="select-classe">
                        <option value="guerreiro">Guerreiro (Foco em Vida/Ataque)</option>
                        <option value="mago">Mago (Foco em Mana)</option>
                        <option value="explorador">Explorador (Equilibrado)</option>
                    </select>
                </div>
                <button class="start-btn" onclick="iniciarJogo()">Come√ßar Jornada</button>
            </div>
        </div>
    </div>

    <div id="game-container">
        <div id="game">
            <img id="scene-image" src="" alt="Cena do Jogo">
            
            <div id="combat-ui">
                <h3 style="margin:0; color:#ff5555">‚öîÔ∏è COMBATE INICIADO!</h3>
                <p>Inimigo: <span id="enemy-name" style="color:white">Monstro</span></p>
                <div style="background:#400; height:10px; width:100%; border-radius:5px; margin-top:5px;">
                    <div id="enemy-hp-bar" style="background:#f00; height:100%; width:100%; border-radius:5px; transition:0.3s"></div>
                </div>
                <p style="text-align:right; margin:5px 0 0 0; font-size:0.8em">HP Inimigo: <span id="enemy-hp-val">100</span>%</p>
            </div>

            <div id="texto-narrativo" style="font-size: 1.1em; line-height: 1.6; margin-bottom: 20px; color: #ccc;"></div>
            <div id="opcoes-area" style="display: flex; flex-direction: column;"></div>
        </div>

        <div id="sidebar">
            <h3 id="hero-name-display" style="color: #fff; border-bottom: 2px solid #ffcc00; padding-bottom: 10px;">Heroi</h3>
            
            <div class="stat-row"><span style="color:#aaa">‚ù§Ô∏è Vida</span> <span class="stat-val"><span id="hp"></span>/<span id="max-hp"></span></span></div>
            <div class="stat-row"><span style="color:#aaa">‚ú® Mana</span> <span id="mana" class="stat-val"></span></div>
            <div class="stat-row"><span style="color:#aaa">‚öîÔ∏è Ataque Total</span> <span id="atk-total" class="stat-val"></span></div>
            
            <div style="margin-top: 20px; margin-bottom: 10px; font-weight: bold; color: #fff;">‚öîÔ∏è Equipado</div>
            <div id="slot-mao" style="color: #888; font-size: 0.9em; margin-bottom: 20px;">M√£o: (Vazio)</div>

            <div style="margin-bottom: 10px; font-weight: bold; color: #fff;">üéí Mochila</div>
            <div id="inventario-lista"></div>

            <div style="margin-top: auto; border-top: 1px solid #333; padding-top: 10px; height: 150px; overflow-y: auto; font-size: 0.85em; color: #666; font-family: monospace;" id="game-log"></div>
        </div>
    </div>

<script>
// --- LINKS ---
const LINKS_SISTEMA = {
    VILOES: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=0&single=true&output=csv",
    RACAS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=1264466421&single=true&output=csv",
    ITENS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=111995480&single=true&output=csv",
    DROPS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=1548671969&single=true&output=csv",
    EVENTOS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=468277323&single=true&output=csv"
};

let DB = {};
let player = { 
    nome: "", hp: 100, maxHp: 100, mana: 50, atk: 5, 
    raca: null, vilao: null, inv: [], flags: {},
    equipamento: { mao: null }
};
let combat = { active: false, enemy: null };

// --- FUN√á√ïES T√âCNICAS ---
function parseCSV(text) {
    const lines = text.split("\n");
    const headers = lines[0].split(",");
    return lines.slice(1).map(line => {
        const values = line.split(",");
        return headers.reduce((obj, header, i) => {
            obj[header.trim()] = values[i] ? values[i].trim() : "";
            return obj;
        }, {});
    });
}

async function carregarDados() {
    try {
        const responses = await Promise.all(Object.values(LINKS_SISTEMA).map(url => fetch(url).then(r => r.text())));
        const keys = Object.keys(LINKS_SISTEMA);
        keys.forEach((key, i) => { DB[key] = parseCSV(responses[i]); });
        prepararMenu();
    } catch (err) { document.getElementById('loading-msg').innerText = "Erro ao conectar."; }
}

function prepararMenu() {
    document.getElementById('loading-msg').style.display = 'none';
    document.getElementById('character-creation').style.display = 'block';
    const select = document.getElementById('select-raca');
    DB.RACAS.forEach((raca, index) => {
        let opt = document.createElement('option');
        opt.value = index; opt.innerText = raca.Nome; select.appendChild(opt);
    });
}

// --- SISTEMA DE JOGO ---

function iniciarJogo() {
    player.nome = document.getElementById('input-nome').value || "Viajante";
    player.raca = DB.RACAS[document.getElementById('select-raca').value];
    const classe = document.getElementById('select-classe').value;

    if (classe === 'guerreiro') { player.maxHp = 120; player.atk = 8; }
    if (classe === 'mago') { player.mana = 100; player.atk = 4; }
    
    player.hp = player.maxHp;
    player.vilao = DB.VILOES[Math.floor(Math.random() * DB.VILOES.length)];

    document.getElementById('menu-screen').style.display = 'none';
    document.getElementById('game-container').style.opacity = '1';
    document.getElementById('game-container').style.pointerEvents = 'all';

    atualizarUI();
    proximaCena("O destino chama...");
}

function atualizarUI() {
    document.getElementById('hero-name-display').innerText = player.nome;
    document.getElementById('hp').innerText = player.hp;
    document.getElementById('max-hp').innerText = player.maxHp;
    document.getElementById('mana').innerText = player.mana;
    
    // C√°lculo de Ataque Total (Base + Arma)
    const weaponDmg = player.equipamento.mao ? parseInt(player.equipamento.mao.Dano || 0) : 0;
    const totalAtk = parseInt(player.atk) + weaponDmg;
    document.getElementById('atk-total').innerText = `${totalAtk} (${player.atk}+${weaponDmg})`;

    // UI de Equipamento
    document.getElementById('slot-mao').innerText = player.equipamento.mao ? `‚öîÔ∏è ${player.equipamento.mao.Nome} (+${weaponDmg} Dano)` : "M√£o: (Desarmado)";
    
    // UI de Invent√°rio
    const lista = document.getElementById('inventario-lista');
    lista.innerHTML = "";
    if (player.inv.length === 0) lista.innerHTML = "<div style='color:#444; font-style:italic; font-size:0.8em'>Vazio</div>";

    player.inv.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = "item-row";
        div.innerHTML = `<span>${item.Nome}</span>`;

        if (item.Tipo === "Arma") {
            const btn = document.createElement('button');
            btn.className = "equip-btn";
            btn.innerText = "Equipar";
            btn.onclick = () => equiparItem(index);
            div.appendChild(btn);
        } else if (item.Tipo === "Pocao" || item.Tipo === "Consumivel") {
            const btn = document.createElement('button');
            btn.className = "equip-btn";
            btn.innerText = "Usar";
            btn.style.backgroundColor = "#2a9d8f";
            btn.onclick = () => usarItem(index);
            div.appendChild(btn);
        }
        lista.appendChild(div);
    });
}

// --- ITENS ---
function equiparItem(index) {
    const item = player.inv[index];
    if (player.equipamento.mao) player.inv.push(player.equipamento.mao);
    player.equipamento.mao = item;
    player.inv.splice(index, 1);
    log(`Voc√™ empunhou: ${item.Nome}`);
    atualizarUI();
}

function usarItem(index) {
    const item = player.inv[index];
    if (item.Nome.includes("Vida")) {
        player.hp = Math.min(player.hp + 20, player.maxHp);
        log("Voc√™ bebeu uma po√ß√£o e recuperou vida.");
    }
    player.inv.splice(index, 1);
    atualizarUI();
}

function log(msg) {
    const logDiv = document.getElementById('game-log');
    logDiv.innerHTML = `> ${msg}<br>` + logDiv.innerHTML;
}

// --- MOTOR DE NARRATIVA E COMBATE ---

function proximaCena(textoExtra = "") {
    if (combat.active) return; // N√£o gera cena nova se estiver em combate

    let evento;
    let tentativas = 0;
    do {
        evento = DB.EVENTOS[Math.floor(Math.random() * DB.EVENTOS.length)];
        tentativas++;
    } while (player.flags[evento.ID] && tentativas < 15);

    // Gera Imagem
    const keyword = evento.Keyword_Imagem || "fantasy landscape";
    const imgUrl = `https://image.pollinations.ai/prompt/dark fantasy painting of ${keyword}?width=600&height=300&nologo=true&seed=${Math.random()}`;
    document.getElementById('scene-image').src = imgUrl;

    const capanga = player.vilao ? (player.vilao.Estilo_Capanga || "Inimigo") : "Inimigo";
    let narrativa = evento.Texto_Base.replace("[Capanga]", capanga);
    
    document.getElementById('texto-narrativo').innerHTML = (textoExtra ? `<span style='color:#ffcc00'>${textoExtra}</span><br><br>` : "") + narrativa;

    const area = document.getElementById('opcoes-area');
    area.innerHTML = "";

    ["Opcao1", "Opcao2", "Opcao3"].forEach(opt => {
        if(evento[opt]) {
            const btn = document.createElement("button");
            btn.className = "btn";
            let custo = parseInt(evento.Custo_Mana) || 0;
            btn.innerText = evento[opt] + (custo > 0 ? ` (‚ú® -${custo} Mana)` : "");
            
            if (custo > 0 && player.mana < custo) btn.disabled = true;

            btn.onclick = () => processarEscolha(evento[opt], evento);
            area.appendChild(btn);
        }
    });
}

function processarEscolha(textoOpcao, evento) {
    // 1. Processa Custo
    let custoMana = parseInt(evento.Custo_Mana) || 0;
    player.mana -= custoMana;
    if(evento.ID) player.flags[evento.ID] = true;

    // 2. Verifica se √© Combate (Pela palavra 'Atacar' ou 'Lutar')
    if (textoOpcao.includes("Atacar") || textoOpcao.includes("Lutar") || textoOpcao.includes("Combater")) {
        const nomeInimigo = player.vilao ? player.vilao.Estilo_Capanga : "Monstro";
        iniciarCombate(nomeInimigo);
        return;
    }

    // 3. Drop Simples (Se n√£o for combate)
    if (Math.random() > 0.7) gerarLoot();

    atualizarUI();
    proximaCena(`Decis√£o: ${textoOpcao}`);
}

// --- SISTEMA DE COMBATE REAL ---

function iniciarCombate(nomeInimigo) {
    combat.active = true;
    combat.enemy = { nome: nomeInimigo, hp: 40, maxHp: 40, atk: 5 }; // Stats do inimigo

    document.getElementById('combat-ui').style.display = 'block';
    document.getElementById('enemy-name').innerText = nomeInimigo;
    
    // Gera imagem do monstro
    const imgUrl = `https://image.pollinations.ai/prompt/scary ${nomeInimigo} monster rpg style?width=600&height=300&nologo=true&seed=${Math.random()}`;
    document.getElementById('scene-image').src = imgUrl;

    document.getElementById('texto-narrativo').innerText = `Um ${nomeInimigo} furioso bloqueia seu caminho! Prepare-se para lutar!`;
    
    atualizarInterfaceCombate();
}

function atualizarInterfaceCombate() {
    // Atualiza Barra de Vida do Inimigo
    const pct = (combat.enemy.hp / combat.enemy.maxHp) * 100;
    document.getElementById('enemy-hp-bar').style.width = `${pct}%`;
    document.getElementById('enemy-hp-val').innerText = Math.floor(pct);

    const area = document.getElementById('opcoes-area');
    area.innerHTML = "";

    // Bot√£o de Ataque
    const btnAtk = document.createElement("button");
    btnAtk.className = "btn";
    btnAtk.innerText = "‚öîÔ∏è Atacar com Arma";
    btnAtk.style.borderColor = "#ff4444";
    btnAtk.onclick = () => turnoCombate('ataque');
    area.appendChild(btnAtk);

    // Bot√£o de Fuga
    const btnFugir = document.createElement("button");
    btnFugir.className = "btn";
    btnFugir.innerText = "üèÉ Tentar Fugir";
    btnFugir.onclick = () => turnoCombate('fuga');
    area.appendChild(btnFugir);
}

function turnoCombate(acao) {
    let msg = "";

    // 1. Turno do Jogador
    if (acao === 'ataque') {
        const weaponDmg = player.equipamento.mao ? parseInt(player.equipamento.mao.Dano || 0) : 0;
        const danoPlayer = parseInt(player.atk) + weaponDmg + Math.floor(Math.random() * 3);
        combat.enemy.hp -= danoPlayer;
        msg += `Voc√™ causou ${danoPlayer} de dano! `;
        log(`Ataque: ${danoPlayer} de dano.`);
    } else if (acao === 'fuga') {
        if (Math.random() > 0.5) {
            encerrarCombate(false);
            proximaCena("Voc√™ escapou por pouco!");
            return;
        } else {
            msg += "Falha na fuga! ";
        }
    }

    // 2. Verifica Morte do Inimigo
    if (combat.enemy.hp <= 0) {
        encerrarCombate(true);
        return;
    }

    // 3. Turno do Inimigo
    const danoInimigo = combat.enemy.atk + Math.floor(Math.random() * 2);
    player.hp -= danoInimigo;
    msg += `Inimigo atacou e causou ${danoInimigo} de dano.`;
    log(`Recebeu: ${danoInimigo} de dano.`);

    // 4. Verifica Morte do Jogador
    if (player.hp <= 0) {
        alert("GAME OVER! Seu her√≥i caiu em batalha.");
        location.reload();
    }

    document.getElementById('texto-narrativo').innerText = msg;
    atualizarUI();
    atualizarInterfaceCombate();
}

function encerrarCombate(vitoria) {
    combat.active = false;
    document.getElementById('combat-ui').style.display = 'none';
    
    if (vitoria) {
        log("Inimigo derrotado!");
        gerarLoot(); // Chance extra de loot por vit√≥ria
        proximaCena("O inimigo caiu. A vit√≥ria √© sua!");
    }
}

function gerarLoot() {
    const item = DB.ITENS[Math.floor(Math.random() * DB.ITENS.length)];
    if(item) {
        player.inv.push(item);
        log(`Saqueou: ${item.Nome}`);
        alert(`Voc√™ encontrou: ${item.Nome}!`);
        atualizarUI();
    }
}

carregarDados();
</script>
</body>
</html>
