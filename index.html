<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>RPG Procedural - A Lenda do Viajante</title>
    <style>
        body { background: #0a0a0a; color: #eee; font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; height: 100vh; overflow: hidden; }
        
        /* TELA DE CRIA√á√ÉO (NOVO) */
        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .menu-box { background: #1a1a1a; padding: 40px; border: 2px solid #333; border-radius: 10px; width: 400px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        .input-group { margin: 20px 0; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; color: #aaa; }
        .input-group select, .input-group input { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }
        .start-btn { background: #ffcc00; color: #000; font-weight: bold; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 1.2em; transition: 0.3s; margin-top: 20px; }
        .start-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px #ffcc00; }

        /* JOGO PRINCIPAL */
        #game-container { display: flex; width: 100%; height: 100%; opacity: 0.3; pointer-events: none; transition: 1s; } /* Come√ßa desativado */
        #game { flex: 3; padding: 40px; display: flex; flex-direction: column; }
        #sidebar { flex: 1; background: #161616; padding: 20px; border-left: 2px solid #333; overflow-y: auto; }
        
        .btn { background: #333; color: #ffcc00; border: 1px solid #555; padding: 15px; margin: 10px 0; cursor: pointer; border-radius: 5px; text-align: left; font-size: 16px; transition: 0.2s; width: 100%; }
        .btn:hover:not(:disabled) { background: #444; border-color: #ffcc00; transform: translateX(5px); }
        .btn:disabled { color: #666; cursor: not-allowed; border-color: #333; opacity: 0.6; }
        .log-entry { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #222; color: #888; font-size: 0.9em; }
        .destaque { color: #fff; font-weight: bold; }
        #combat-screen { display: none; background: #2a0a0a; padding: 20px; border-radius: 10px; border: 1px solid #ff4444; margin-bottom: 20px; animation: flashRed 0.5s; }
        @keyframes flashRed { from { background: #500; } to { background: #2a0a0a; } }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .stat-label { color: #aaa; }
        .stat-val { font-weight: bold; color: #ffcc00; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <h1 style="color: #ffcc00; font-size: 3em; margin-bottom: 10px;">A LENDA PROCEDURAL</h1>
        <p style="color: #666; margin-bottom: 30px;">Carregando universo...</p>
        
        <div id="loading-msg" style="color: #ffcc00;">Conectando ao Google Sheets...</div>

        <div id="character-creation" class="menu-box" style="display: none;">
            <h2>Crie seu Her√≥i</h2>
            
            <div class="input-group">
                <label>Nome do Personagem</label>
                <input type="text" id="input-nome" placeholder="Ex: Gandalf, o Cinza">
            </div>

            <div class="input-group">
                <label>Ra√ßa</label>
                <select id="select-raca"></select> </div>

            <div class="input-group">
                <label>Classe Inicial</label>
                <select id="select-classe">
                    <option value="guerreiro">Guerreiro (+5 Vida, +2 Ataque)</option>
                    <option value="mago">Mago (+20 Mana, +1 Ataque)</option>
                    <option value="ladino">Ladino (+10 Sorte, +3 Ataque)</option>
                </select>
            </div>

            <button class="start-btn" onclick="iniciarJogo()">INICIAR AVENTURA</button>
        </div>
    </div>

    <div id="game-container">
        <div id="game">
            <h2 id="titulo-cena" style="color: #ffcc00;">...</h2>
            
            <div id="combat-screen">
                <h3 style="color: #ff4444; margin-top: 0;">‚öîÔ∏è COMBATE!</h3>
                <p>Inimigo: <span id="enemy-name" class="destaque">-</span> | HP: <span id="enemy-hp">??</span></p>
                <div id="combat-log" style="font-style: italic; color: #ccc;"></div>
            </div>

            <div id="texto-narrativo" style="font-size: 1.2em; line-height: 1.6; margin-bottom: 20px; min-height: 80px;"></div>
            <div id="opcoes-area" style="display: flex; flex-direction: column;"></div>
        </div>

        <div id="sidebar">
            <h3 id="hero-name-display">Viajante</h3>
            <div class="stat-row"><span class="stat-label">‚ù§Ô∏è Vida</span> <span class="stat-val"><span id="hp"></span>/<span id="max-hp"></span></span></div>
            <div class="stat-row"><span class="stat-label">‚ú® Mana</span> <span id="mana" class="stat-val"></span></div>
            <div class="stat-row"><span class="stat-label">‚öîÔ∏è Ataque</span> <span id="atk" class="stat-val"></span></div>
            <div class="stat-row"><span class="stat-label">üß¨ Ra√ßa</span> <span id="raca" class="stat-val"></span></div>
            <div class="stat-row"><span class="stat-label">üëπ Vil√£o</span> <span id="vilao" class="stat-val" style="color:#ff4444"></span></div>
            
            <hr style="border-color: #333;">
            <h3>üéí Invent√°rio</h3>
            <ul id="inventario-lista" style="padding-left: 20px; color: #aaa;"></ul>
            
            <hr style="border-color: #333;">
            <h3>üìú Di√°rio</h3>
            <div id="game-log" style="height: 200px; overflow-y: auto; font-family: monospace;"></div>
        </div>
    </div>

<script>
// --- CONFIGURA√á√ÉO ---
const LINKS_SISTEMA = {
    VILOES: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=0&single=true&output=csv",
    RACAS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=1264466421&single=true&output=csv",
    ITENS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=111995480&single=true&output=csv",
    DROPS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=1548671969&single=true&output=csv",
    EVENTOS: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXmWaCWAZyq4Sj5PVfQCYZRCucsYXU9rWGsxyiMS_IdYnmvf80Y_LCePmBwGCUqtpvdsKE61xO0CJ2/pub?gid=468277323&single=true&output=csv"
};

let DB = {};
let player = { nome: "Viajante", hp: 100, maxHp: 100, mana: 50, atk: 5, raca: null, vilao: null, inv: [], flags: {} };
let combatState = { active: false, enemy: null };

// --- ENGINE ---

function parseCSV(text) {
    const lines = text.split("\n");
    const headers = lines[0].split(",");
    return lines.slice(1).map(line => {
        const values = line.split(",");
        return headers.reduce((obj, header, i) => {
            obj[header.trim()] = values[i] ? values[i].trim() : "";
            return obj;
        }, {});
    });
}

async function carregarDados() {
    try {
        const responses = await Promise.all(Object.values(LINKS_SISTEMA).map(url => fetch(url).then(r => r.text())));
        const keys = Object.keys(LINKS_SISTEMA);
        keys.forEach((key, i) => { DB[key] = parseCSV(responses[i]); });
        
        prepararMenu(); // CHAMA O MENU QUANDO TERMINAR
    } catch (err) {
        document.getElementById('loading-msg').innerText = "Erro ao carregar dados. Verifique a internet.";
    }
}

function prepararMenu() {
    document.getElementById('loading-msg').style.display = 'none';
    document.getElementById('character-creation').style.display = 'block';
    
    // Preenche o Select de Ra√ßas com os dados da planilha
    const select = document.getElementById('select-raca');
    DB.RACAS.forEach((raca, index) => {
        let opt = document.createElement('option');
        opt.value = index;
        opt.innerText = raca.Nome;
        select.appendChild(opt);
    });
}

function iniciarJogo() {
    // 1. Pega os dados do Menu
    const nomeInput = document.getElementById('input-nome').value;
    player.nome = nomeInput || "Viajante Sem Nome";
    
    const racaIndex = document.getElementById('select-raca').value;
    player.raca = DB.RACAS[racaIndex];
    
    const classe = document.getElementById('select-classe').value;

    // 2. Aplica B√¥nus de Classe
    if (classe === 'guerreiro') { player.maxHp += 5; player.hp += 5; player.atk += 2; }
    if (classe === 'mago') { player.mana += 20; player.atk += 1; }
    if (classe === 'ladino') { player.atk += 3; }

    // 3. Sorteia o Vil√£o
    player.vilao = DB.VILOES[Math.floor(Math.random() * DB.VILOES.length)];

    // 4. Esconde Menu e Mostra Jogo
    document.getElementById('menu-screen').style.display = 'none';
    document.getElementById('game-container').style.opacity = '1';
    document.getElementById('game-container').style.pointerEvents = 'all';

    atualizarUI();
    log(`Bem-vindo, ${player.nome} da ra√ßa ${player.raca.Nome}!`);
    proximaCena("Sua lenda come√ßa agora...");
}

// ... (MANTENHA AS FUN√á√ïES DE LOG, ATUALIZAR UI, COMBATE E PROXIMA CENA IGUAIS √ÄS ANTERIORES) ...
// Para economizar espa√ßo, vou colar apenas as fun√ß√µes essenciais que precisam conversar com o novo sistema.
// Se voc√™ copiou o c√≥digo anterior, as fun√ß√µes abaixo s√£o as mesmas, s√≥ o 'atualizarUI' muda um pouco.

function log(msg) {
    const logDiv = document.getElementById('game-log');
    const entry = document.createElement('div');
    entry.className = "log-entry";
    entry.innerText = `> ${msg}`;
    logDiv.prepend(entry);
}

function atualizarUI() {
    document.getElementById('hero-name-display').innerText = player.nome; // Mostra o nome escolhido
    document.getElementById('hp').innerText = player.hp;
    document.getElementById('max-hp').innerText = player.maxHp;
    document.getElementById('mana').innerText = player.mana;
    document.getElementById('atk').innerText = player.atk;
    document.getElementById('raca').innerText = player.raca ? player.raca.Nome : "-";
    document.getElementById('vilao').innerText = player.vilao ? player.vilao.Nome : "-";
    
    const lista = document.getElementById('inventario-lista');
    lista.innerHTML = player.inv.length ? "" : "<li>(Mochila Vazia)</li>";
    player.inv.forEach(item => {
        let li = document.createElement('li');
        li.innerText = item.Nome;
        lista.appendChild(li);
    });

    if (player.hp <= 0) {
        alert("GAME OVER! Aperte F5 para tentar novamente.");
        location.reload();
    }
}

function proximaCena(textoExtra = "") {
    let evento;
    let tentativas = 0;
    do {
        evento = DB.EVENTOS[Math.floor(Math.random() * DB.EVENTOS.length)];
        tentativas++;
    } while (player.flags[evento.ID] && tentativas < 10);

    const capanga = player.vilao ? (player.vilao.Estilo_Capanga || "Inimigo") : "Inimigo";
    let narrativa = evento.Texto_Base.replace("[Capanga]", capanga);
    
    document.getElementById('titulo-cena').innerText = "O que voc√™ faz?";
    document.getElementById('texto-narrativo').innerText = (textoExtra ? textoExtra + "\n\n" : "") + narrativa;

    const area = document.getElementById('opcoes-area');
    area.innerHTML = "";

    ["Opcao1", "Opcao2", "Opcao3"].forEach(opt => {
        if(evento[opt]) {
            const btn = document.createElement("button");
            btn.className = "btn";
            let custo = parseInt(evento.Custo_Mana) || 0;
            btn.innerText = evento[opt] + (custo > 0 ? ` (üíß -${custo})` : "");
            
            if (custo > 0 && player.mana < custo) {
                btn.disabled = true;
                btn.innerText += " [Mana Insuficiente]";
            }

            btn.onclick = () => processarEscolha(evento[opt], evento);
            area.appendChild(btn);
        }
    });
}

function processarEscolha(textoOpcao, evento) {
    let custoMana = parseInt(evento.Custo_Mana) || 0;
    if (player.mana < custoMana) return;
    player.mana -= custoMana;
    if(evento.ID) player.flags[evento.ID] = true;

    if (textoOpcao.includes("Atacar") || textoOpcao.includes("Lutar")) {
        iniciarCombate(player.vilao.Estilo_Capanga);
        return;
    }

    if (Math.random() > 0.6) ganharLoot();

    log(`A√ß√£o: ${textoOpcao}`);
    atualizarUI();
    proximaCena(`Voc√™ decidiu: ${textoOpcao}`);
}

function iniciarCombate(nomeInimigo) {
    combatState.active = true;
    combatState.enemy = { nome: nomeInimigo, hp: 30, atk: 4 };
    document.getElementById('combat-screen').style.display = 'block';
    document.getElementById('enemy-name').innerText = nomeInimigo;
    document.getElementById('enemy-hp').innerText = 30;
    gerarBotoesCombate();
}

function gerarBotoesCombate() {
    const area = document.getElementById('opcoes-area');
    area.innerHTML = "";
    const btnAtk = document.createElement("button");
    btnAtk.className = "btn";
    btnAtk.innerText = "‚öîÔ∏è Atacar";
    btnAtk.onclick = () => turnoCombate('ataque');
    area.appendChild(btnAtk);
    
    const btnFugir = document.createElement("button");
    btnFugir.className = "btn";
    btnFugir.innerText = "üèÉ Fugir";
    btnFugir.onclick = () => {
        combatState.active = false;
        document.getElementById('combat-screen').style.display = 'none';
        proximaCena("Voc√™ fugiu!");
    };
    area.appendChild(btnFugir);
}

function turnoCombate(acao) {
    let logMsg = "";
    if (acao === 'ataque') {
        let dano = player.atk + Math.floor(Math.random() * 3);
        combatState.enemy.hp -= dano;
        logMsg = `Causou ${dano} de dano!`;
    }
    if (combatState.enemy.hp <= 0) {
        combatState.active = false;
        document.getElementById('combat-screen').style.display = 'none';
        ganharLoot();
        proximaCena("Inimigo derrotado!");
        return;
    }
    let danoInimigo = combatState.enemy.atk;
    player.hp -= danoInimigo;
    document.getElementById('combat-log').innerText = logMsg + ` Recebeu ${danoInimigo} de dano!`;
    document.getElementById('enemy-hp').innerText = combatState.enemy.hp;
    atualizarUI();
}

function ganharLoot() {
    const itemSorteado = DB.ITENS[Math.floor(Math.random() * DB.ITENS.length)];
    if (itemSorteado) {
        player.inv.push(itemSorteado);
        if(itemSorteado.Tipo === "Arma") player.atk += parseInt(itemSorteado.Dano || 2);
        log(`Item obtido: ${itemSorteado.Nome}`);
        alert(`Voc√™ encontrou: ${itemSorteado.Nome}!`);
    }
}

carregarDados();
</script>
</body>
</html>
